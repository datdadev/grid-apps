<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="The Uy 3D Printing Service - Browser-based 3D slicer">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Uy 3D Printing Service</title>

    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon-mobile.png">

    <!-- Base Kiri styles (from v1) -->
    <link rel="stylesheet" type="text/css" href="index.css">
    <link href="manifest.json" rel="manifest">

    <!-- Font Awesome (icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Modern font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (Using CDN for immediate beautification assurance, you can switch back to local) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script>
        window.kiriPointerOffset = window.kiriPointerOffset || { x: -400, y: 0 };
    </script>

    <style>
        html, body {
            height: 100%;
            background-color: #f8fafc;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        /* Custom Scrollbar - Refined */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loader Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 3D Canvas Container */
        #customer-viewer canvas {
            outline: none;
            position: absolute;
            width: 100% !important;
            height: 100% !important;
            display: block; /* Fixes tiny scrollbar issues */
        }
        /* Ensure the Kiri container obeys the viewer window instead of the full page */
        #kiri-view-window {
            position: absolute;
            inset: 0;
        }
        #kiri-view-window #container {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* --- Modern minimal range slider (horizontal) --- */
        input[type=range].modern-range {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 8px 0;
        }
        input[type=range].modern-range:focus {
            outline: none;
        }
        input[type=range].modern-range::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px; /* Thinner track for minimal look */
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 999px;
            transition: background 0.2s;
        }
        input[type=range].modern-range:hover::-webkit-slider-runnable-track {
            background: #cbd5e1;
        }
        input[type=range].modern-range::-webkit-slider-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #ffffff;
            border: 5px solid #4f46e5; /* Color ring style */
            cursor: grab;
            -webkit-appearance: none;
            margin-top: -7px; /* Centering: (18px thumb - 4px track) / 2 * -1 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.15s ease;
        }
        input[type=range].modern-range:hover::-webkit-slider-thumb {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.25);
        }
        input[type=range].modern-range:active::-webkit-slider-thumb {
            cursor: grabbing;
            transform: scale(0.95);
            border-width: 6px;
        }
        input[type=range].modern-range::-moz-range-track {
            height: 4px;
            background: #e2e8f0;
            border-radius: 999px;
            transition: background 0.2s;
            cursor: pointer;
        }
        input[type=range].modern-range:hover::-moz-range-track {
            background: #cbd5e1;
        }
        input[type=range].modern-range::-moz-range-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #ffffff;
            border: 5px solid #4f46e5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.15s ease;
            cursor: grab;
        }
        input[type=range].modern-range:hover::-moz-range-thumb {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.25);
        }
        input[type=range].modern-range:active::-moz-range-thumb {
            cursor: grabbing;
            transform: scale(0.95);
            border-width: 6px;
        }

        /* --- MODERN SLICE SCRUBBER (VERTICAL) --- */
        .slice-scrubber {
            writing-mode: vertical-lr;
            direction: rtl; /* invert so max is at top */
            -webkit-appearance: none;
            appearance: none;
            width: 18px; /* Clickable width area */
            background: transparent;
            display: block;
            height: calc(100vh - 250px);
            max-height: calc(100vh - 240px);
            margin: 0 auto;
            cursor: pointer;
        }
        .slice-scrubber:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        /* Webkit Track (Vertical) */
        .slice-scrubber::-webkit-slider-runnable-track {
            width: 5px; /* Very thin hairline track */
            background: #cbd5e1;
            border-radius: 99px;
            border: none;
        }
        /* Webkit Thumb (Vertical) */
        .slice-scrubber::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4f46e5;
            border: 3px solid #ffffff;
            margin-left: -7.5px; /* Center horizontally: -((20px thumb - 2px track)/2) */
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 1px rgba(79, 70, 229, 0.1);
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .slice-scrubber:hover::-webkit-slider-thumb {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .slice-scrubber:active::-webkit-slider-thumb {
            transform: scale(1.0);
            background: #4338ca;
            cursor: grabbing;
        }
        .slice-scrubber:disabled::-webkit-slider-thumb {
            background: #94a3b8;
            border-color: #f1f5f9;
            box-shadow: none;
        }
        /* Firefox track/thumb */
        .slice-scrubber::-moz-range-track {
            width: 2px;
            background: #cbd5e1;
            border-radius: 99px;
            border: none;
        }
        .slice-scrubber::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4f46e5;
            border: 3px solid #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 1px rgba(79, 70, 229, 0.1);
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .slice-scrubber:hover::-moz-range-thumb {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .slice-scrubber:active::-moz-range-thumb {
            transform: scale(1.0);
            background: #4338ca;
            cursor: grabbing;
        }
        .slice-scrubber:disabled::-moz-range-thumb {
            background: #94a3b8;
            border-color: #f1f5f9;
            box-shadow: none;
        }
/* Hide "pro" UI */
        #top, #progress, #render-tools, #mid {
            display: none !important;
        }
    </style>

    <!-- Kiri dependencies (from v1) -->
    <script src="../lib/ext/tween.js"></script>
    <!-- kiri main app -->
    <script src="../lib/main/kiri.js" type="module"></script>
</head>

<body class="simple-flow text-slate-600 antialiased bg-slate-50 h-full min-h-screen overflow-hidden">
<div id="app" class="flex flex-col h-full min-h-screen">

    <!-- Loading Curtain -->
    <div id="curtain" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm transition-opacity duration-500">
        <div class="loader w-12 h-12 mb-4 !border-4 !border-t-indigo-600"></div>
        <div class="text-slate-600 font-medium tracking-wide animate-pulse">
            The Uy 3D Printing Service is Loading
        </div>
    </div>

    <!-- CUSTOMER-FACING SIMPLE UI -->
    <div id="customer-shell" class="customer-shell h-full min-h-screen w-full">
        <div class="flex h-full min-h-screen flex-col md:flex-row overflow-hidden">

            <!-- LEFT: upload/settings/quote -->
            <aside class="w-full md:w-[400px] bg-white border-r border-slate-200 flex flex-col z-30 shadow-xl md:shadow-slate-200/50 overflow-y-auto h-full relative">

                <!-- Header -->
                <div class="p-6 pb-4 border-b border-slate-100 flex-col bg-white sticky top-0 z-10">
                    <div class="flex items-center gap-4 mb-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 transform transition-transform hover:scale-105">
                            <i class="fa-solid fa-cube text-xl"></i>
                        </div>
                        <div class="flex flex-col">
                            <h1 class="font-bold text-xl text-slate-900 tracking-tight">The Uy 3D Printing</h1>
                            <p class="text-xs text-indigo-500 font-semibold uppercase tracking-wider">Service v2.0</p>
                        </div>
                    </div>
                    <div class="mt-3 inline-flex items-center gap-2 px-3 py-1 bg-emerald-50 border border-emerald-100 rounded-full">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                        <span class="text-[11px] font-medium text-emerald-700">Online · Creality K1 Ready</span>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-6 space-y-8 flex-col flex-1">

                    <!-- 1. Upload -->
                    <div class="flex-col space-y-3">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">1. Upload Model</h2>
                            <span id="file-status-badge"
                                  class="text-[10px] bg-slate-100 text-slate-500 px-2.5 py-1 rounded-md font-bold border border-slate-200">
                                WAITING
                            </span>
                        </div>

                        <!-- Drop zone -->
                        <div
                        id="customer-drop-zone"
                        class="group relative w-full border-2 border-dashed border-slate-300
                                rounded-2xl p-8 text-center hover:border-indigo-500
                                hover:bg-indigo-50/50 transition-all duration-300 cursor-pointer
                                bg-slate-50/50 flex items-center justify-center"
                        >
                            <input
                            type="file"
                            id="customer-file-input"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                            accept=".stl,.obj,.3mf"
                            multiple
                            >
                            <div class="pointer-events-none flex flex-col items-center transition-transform duration-300 group-hover:-translate-y-1">
                                <div class="w-14 h-14 bg-white text-indigo-500 shadow-sm border border-slate-100 rounded-full flex items-center justify-center mb-3 group-hover:bg-indigo-600 group-hover:text-white group-hover:shadow-indigo-200 transition-all duration-300">
                                    <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                                </div>
                                <p id="customer-drop-text" class="text-sm font-semibold text-slate-700 group-hover:text-indigo-700">
                                    Click to browse or drop STL
                                </p>
                                <p class="text-xs text-slate-400 mt-1 font-medium">
                                    Supports STL, OBJ, 3MF (Max 200MB)
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Settings -->
                    <div class="space-y-4 flex-col" id="settings-panel">
                        <div class="flex items-center gap-2">
                             <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">2. Configuration</h2>
                             <div class="h-px bg-slate-200 flex-1"></div>
                        </div>

                        <div class="flex-col space-y-5 bg-white rounded-xl">
                            <!-- Infill Type -->
                            <div class="flex-col group">
                                <label class="block text-xs font-semibold text-slate-600 mb-2 ml-1">Infill Pattern</label>
                                <div class="relative">
                                    <select id="customer-infill-type"
                                            class="w-full bg-slate-50 hover:bg-white border border-slate-200 text-slate-700 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white block p-3 pl-4 appearance-none transition-all shadow-sm font-medium cursor-pointer outline-none">
                                        <option value="hex">Hexagon (Strong)</option>
                                        <option value="grid">Grid (Standard)</option>
                                        <option value="gyroid">Gyroid (Isotropic)</option>
                                        <option value="linear">Lines (Fast)</option>
                                        <option value="triangle">Triangles</option>
                                        <option value="cubic">Cubic</option>
                                    </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500 group-hover:text-indigo-600 transition-colors">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                            <!-- Infill Density -->
                            <div class="flex-col p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex justify-between mb-2 items-end">
                                    <label class="text-xs font-semibold text-slate-600">Infill Density</label>
                                    <span id="customer-infill-value" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md border border-indigo-100">15%</span>
                                </div>
                                <input id="customer-infill-amount"
                                       type="range"
                                       min="0"
                                       max="100"
                                       step="1"
                                       value="15"
                                       class="modern-range">
                                <div class="flex justify-between text-[10px] text-slate-400 font-medium mt-1">
                                    <span>Hollow</span>
                                    <span>Solid (100%)</span>
                                </div>
                            </div>

                            <!-- Support Toggle -->
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex-1 flex-col pr-3">
                                    <p class="text-xs font-semibold text-slate-600">Support</p>
                                    <p class="text-[11px] text-slate-400 mt-1">Generate supports for overhangs</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer select-none">
                                    <input id="customer-support-toggle" type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:bg-indigo-500 transition-all duration-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-slate-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                                    <span class="sr-only">Enable support generation</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Quote -->
                    <div class="flex-col space-y-4 pb-4">
                         <div class="flex items-center gap-2">
                             <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">3. Summary</h2>
                             <div class="h-px bg-slate-200 flex-1"></div>
                        </div>

                        <div class="flex-col bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 shadow-lg text-white space-y-4 relative overflow-hidden group">
                            <!-- Decorative background blur -->
                            <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-3xl group-hover:bg-indigo-500/30 transition-colors duration-500"></div>

                            <div class="flex justify-between items-center text-sm relative z-10">
                                <span class="text-slate-400 flex items-center gap-2">
                                    <i class="fa-regular fa-clock"></i> Est. Time
                                </span>
                                <span id="customer-stat-time" class="font-mono font-medium text-indigo-200">--:--</span>
                            </div>
                            <div class="flex justify-between items-center text-sm relative z-10">
                                <span class="text-slate-400 flex items-center gap-2">
                                    <i class="fa-solid fa-weight-hanging"></i> Material
                                </span>
                                <span id="customer-stat-weight" class="font-mono font-medium text-indigo-200">-- g</span>
                            </div>
                            <div class="border-t border-slate-700/50 my-2 relative z-10"></div>
                            <div class="flex justify-between items-center relative z-10">
                                <span class="font-medium text-slate-300">Estimated Price</span>
                                <span id="customer-stat-price" class="font-bold text-2xl tracking-tight text-white">--</span>
                            </div>
                        </div>

                        <p id="customer-pricing-note" class="text-center text-xs text-slate-400 italic">
                            Ready? Click below to analyze geometry & price.
                        </p>

                        <div class="flex gap-2">
                            <button id="customer-slice-btn"
                                    type="button"
                                    class="flex-1 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:cursor-not-allowed text-white font-bold rounded-xl text-sm px-5 py-4 text-center inline-flex items-center justify-center transition-all shadow-lg shadow-indigo-500/30 active:scale-[0.98] hover:-translate-y-0.5">
                                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>
                                Slice &amp; Get Price
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-slate-50/80 backdrop-blur border-t border-slate-200 sticky bottom-0 z-20">
                    <button
                        id="customer-order-btn"
                        class="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold
                            rounded-xl text-sm px-5 py-4 transition-all shadow-xl
                            active:scale-[0.98] flex items-center justify-center gap-2
                            disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <span>Place Order Now</span>
                        <i class="fa-solid fa-arrow-right text-xs"></i>
                    </button>
                </div>
            </aside>

            <!-- RIGHT: 3D viewer -->
            <main class="flex-1 relative bg-slate-100 flex flex-col h-full min-h-screen overflow-hidden">
                <!-- Enhanced hint bar -->
                <div class="absolute top-6 left-6 right-6 z-10 flex justify-end pointer-events-none">
                    <div class="pointer-events-auto px-4 py-2 bg-white/90 backdrop-blur-md rounded-full shadow-sm border border-slate-200/60 text-xs font-medium text-slate-500 flex items-center gap-3 transition-opacity hover:opacity-100 opacity-70">
                        <div class="flex items-center gap-1">
                            <i class="fa-solid fa-mouse text-indigo-500"></i>
                            <span>Interact:</span>
                        </div>
                        <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200">Left Click: Rotate</span>
                        <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200">Right Click: Pan</span>
                        <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200">Scroll: Zoom</span>
                    </div>
                </div>

                <!-- Viewer container -->
                <div id="customer-viewer" class="w-full h-full relative bg-[#f0f2f5]">
                    <!-- Dedicated Kiri host to prevent fullscreen spillover -->
                    <div id="kiri-view-window" class="absolute inset-0"></div>
                    <!-- Enhanced Gradient Overlay for depth -->
                    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white via-slate-50 to-slate-200 pointer-events-none"></div>

                    <!-- Slice preview control -->
                    <div id="slice-preview-panel"
                         class="items-center absolute top-20 inset-y-8 right-6 z-20 hidden md:flex flex-col gap-3 bg-white/95 backdrop-blur-md border border-slate-200 rounded-2xl shadow-lg shadow-indigo-100 px-2 py-3 pointer-events-auto transition-all">
                        <div class="flex items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.08em] text-slate-500">
                            <i class="fa-solid fa-layer-group text-indigo-500"></i>
                            <span>Preview</span>
                        </div>
                        <div class="flex-col flex items-stretch gap-3">
                            <div class="flex flex-col items-center text-[11px] text-slate-500 gap-1 pt-1">
                                <span class="text-sm font-bold text-slate-800" id="slice-layer-label">-- / --</span>
                                <span class="px-2 py-0.5 bg-slate-100 rounded-full border border-slate-200 text-[10px] font-semibold uppercase tracking-wide">Layer</span>
                            </div>
                            <div class="flex-1 flex items-center justify-center px-2 h-full">
                                <input id="slice-layer-slider"
                                       class="slice-scrubber bg-transparent"
                                       type="range"
                                       min="0"
                                       max="0"
                                       step="1"
                                       value="0"
                                       disabled
                                >
                            </div>
                        </div>
                        <div id="slice-preview-hint" class="text-[11px] text-slate-400 leading-snug">
                            Slice to view.
                        </div>
                    </div>

                    <div id="viewer-placeholder"
                         class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none z-0">
                        <div class="w-32 h-32 rounded-full bg-slate-100 flex items-center justify-center mb-6 shadow-inner border border-slate-50">
                             <i class="fa-solid fa-cube text-6xl opacity-20 text-indigo-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-400">3D Viewer Ready</h3>
                        <p class="text-sm text-slate-400 mt-2">Upload a model to see the magic</p>
                    </div>

                    <!-- Undo + Interaction panel (repositioned) -->
                    <div id="viewer-interact"
                         class="absolute left-6 bottom-6 z-20 hidden md:flex items-center gap-2 bg-white/95 backdrop-blur-md border border-slate-200 rounded-2xl shadow-lg shadow-indigo-100 px-3 py-2 pointer-events-auto transition-all">
                        <button id="viewer-undo"
                                class="text-xs font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 border border-slate-200 rounded-lg px-3 py-1.5 transition disabled:opacity-60 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-rotate-left mr-1"></i> Undo
                        </button>
                        <div class="flex items-center gap-2 text-[10px] text-slate-500">
                            <i class="fa-solid fa-hand text-indigo-500"></i>
                            <span>Interaction locked</span>
                        </div>
                    </div>

                    <!-- Objects list panel (top-left) -->
                    <div id="plate-object-panel"
                         class="absolute left-6 top-6 z-20 hidden md:flex flex-col gap-2 bg-white/95 backdrop-blur-md border border-slate-200 rounded-2xl shadow-lg shadow-indigo-100 px-4 py-3 pointer-events-auto transition-all max-w-xs w-64">
                        <div class="flex items-center justify-between text-[11px] font-semibold text-slate-600">
                            <span class="flex items-center gap-2">
                                <i class="fa-solid fa-box text-indigo-500"></i>
                                <span>Objects on Plate</span>
                            </span>
                            <span id="plate-object-count" class="text-[10px] text-slate-400 font-medium">0</span>
                        </div>
                        <ul id="plate-object-list" class="text-[11px] text-slate-500 space-y-1 max-h-36 overflow-auto pr-1 custom-scroll">
                            <li class="text-slate-400">No objects loaded</li>
                        </ul>
                    </div>
                </div>
            </main>

            <!-- Slice Progress -->
            <div id="slice-progress" class="absolute bottom-0 left-[400px] right-0 h-2 bg-slate-200/80 overflow-hidden mb-0 pointer-events-none opacity-0 transition-opacity duration-200 z-20 shadow-sm">
                <div id="slice-progress-bar" class="h-full w-0 bg-gradient-to-r from-indigo-500 via-sky-500 to-emerald-500 transition-all duration-150 ease-linear"></div>
            </div>
        </div>

        <!-- ORDER MODAL -->
        <section id="customer-order-form"
         class="fixed mx-auto inset-0 w-full h-full z-[999] bg-slate-900/60 backdrop-blur-sm
                flex items-center justify-center p-4 hidden"
         >
            <div class="flex-col bg-white rounded-3xl shadow-2xl w-full max-w-lg
                        overflow-hidden transform transition-all scale-100
                        animate-in fade-in zoom-in duration-200">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div class="flex-col">
                        <h3 class="text-lg font-bold text-slate-900">Finalize Order</h3>
                        <p class="text-xs text-slate-500">We just need a few details.</p>
                    </div>
                    <button id="close-order-modal" class="w-8 h-8 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-500 hover:text-slate-700 flex items-center justify-center transition-colors">
                        <i class="fa-solid fa-times text-sm"></i>
                    </button>
                </div>

                <form id="customer-form" class="p-6 space-y-4">
                    <div class="flex-col">
                        <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Full Name</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                <i class="fa-regular fa-user"></i>
                            </div>
                            <input id="customer-name"
                                   type="text"
                                   placeholder="e.g. Nguyen Van A"
                                   autocomplete="name"
                                   class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block p-3 pl-10 outline-none transition-all">
                        </div>
                    </div>
                    <div class="flex-col">
                        <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Phone / Zalo</label>
                        <div class="relative">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                <i class="fa-solid fa-phone"></i>
                            </div>
                            <input id="customer-phone"
                                   type="tel"
                                   placeholder="0912 345 678"
                                   autocomplete="tel"
                                   class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block p-3 pl-10 outline-none transition-all">
                        </div>
                    </div>
                    <div class="flex-col">
                        <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Special Instructions</label>
                        <textarea id="customer-notes"
                                  rows="5"
                                  placeholder="Color preference, material specifics, or deadline..."
                                  class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block p-3 resize-none outline-none transition-all"></textarea>
                    </div>
                </form>

                <div class="flex-col p-6 bg-slate-50 border-t border-slate-100">
                    <button id="customer-submit-order"
                            type="button"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-indigo-500/30 transition-all active:scale-[0.98] flex justify-center items-center gap-2">
                        <span>Send Order Request</span>
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                    <p class="text-center text-[11px] text-slate-400 mt-3">
                        <i class="fa-solid fa-lock mr-1"></i> Information is stored locally on your browser.
                    </p>
                </div>
            </div>
        </section>
    </div>

    <!-- === ORIGINAL APP STRUCTURE (KEPT FOR FUNCTIONALITY) === -->

    <!-- when running iframed, provide a separator between the menu bar and enclosing page -->
    <div id="top-sep"></div>

    <!-- top menu bar (hidden by CSS above, but still here for kiri logic) -->
    <div id="top" class="f-row">
        <div class="f-row top-menu">
            <span id="view-arrange">
                <span><i class="fas fa-shapes"></i></span>
                <label lk="arrange">arrange</label>
            </span>
            <span id="act-slice" style="display:none;"></span>
            <span id="act-preview" style="display:none;"></span>
            <span id="act-animate" style="display:none;"></span>
            <span id="act-export">
                <span><i class="fas fa-file-download"></i></span>
                <label id="label-export" title="generate gcode" lk="export">export</label>
            </span>
        </div>
        <div class="grow"></div>
        <div id="app-name" class="f-col a-center top-menu">
            <span class="grow">
                <span id="app-name-text" class="km-font">The Uy 3D Printing Service</span>
            </span>
        </div>
        <div id="doit" class="f-row a-center">
            <button id="undo"><i class="fas fa-undo-alt"></i></button>
            <button id="redo"><i class="fas fa-redo-alt"></i></button>
        </div>
        <div class="grow"></div>
        <div class="f-row top-menu">
            <span>
                <i class="fas fa-folder"></i>
                <label lk="fe_menu">files</label>
                <div class="top-menu-drop top-menu-right">
                    <div class="content">
                        <div id="file-new">
                            <label lk="new">new</label>
                            <span><i class="fas fa-file"></i></span>
                        </div>
                        <hr>
                        <div id="file-recent" style="display:none;"></div>
                        <div id="file-import">
                            <label lk="import">import</label>
                            <span><i class="fas fa-file-upload"></i></span>
                            <input id="load-file" type="file" name="loadme" style="display:none">
                        </div>
                        <div id="app-export" style="display:none;"></div>
                    </div>
                </div>
            </span>
            <span>
                <i class="fas fa-eye"></i>
                <label lk="vu_menu">view</label>
                <div class="top-menu-drop top-menu-right">
                    <div class="content">
                        <div id="view-home">
                            <label lk="home">home</label>
                            <span><i class="fas fa-home"></i></span>
                        </div>
                        <hr>
                        <div id="view-top">
                            <label lk="top">top</label>
                            <span><i class="fas fa-square"></i></span>
                        </div>
                        <div id="view-front">
                            <label lk="front">top</label>
                            <span><i class="fas fa-square"></i></span>
                        </div>
                        <div id="view-back">
                            <label lk="back">top</label>
                            <span><i class="fas fa-square"></i></span>
                        </div>
                        <div id="view-left">
                            <label lk="left">top</label>
                            <span><i class="fas fa-square"></i></span>
                        </div>
                        <div id="view-right">
                            <label lk="right">top</label>
                            <span><i class="fas fa-square"></i></span>
                        </div>
                        <hr>
                        <div id="app-xpnd">
                            <label lk="fullscreen">fullscreen</label>
                            <span><i class="fas fa-maximize"></i></span>
                        </div>
                    </div>
                </div>
            </span>
            <!-- mode menu (kept for logic, hidden via CSS) -->
            <span style="pointer-events: none; opacity: 0.3; display:none;">
                <i class="fas fa-code-branch"></i>
                <label lk="mo_menu">mode</label>
                <div class="top-menu-drop top-menu-right">
                    <div class="content">
                        <div id="mode-fdm">
                            <label title="3D Additive Printing Processes">FDM</label>
                            <span><i class="fas fa-layer-group"></i></span>
                        </div>
                        <div id="mode-cam">
                            <label title="CNC Mills and Subtractive Processes">CNC</label>
                            <span><i class="fas fa-bore-hole"></i></span>
                        </div>
                        <div id="mode-sla">
                            <label title="mSLA Resin Printing">SLA</label>
                            <span><i class="fas fa-cube"></i></span>
                        </div>
                        <hr>
                        <div id="mode-laser">
                            <label title="Laser Cutting and Engraving">Laser</label>
                            <span><i class="fas fa-bolt"></i></span>
                        </div>
                        <div id="mode-wjet">
                            <label title="WaterJet Cutting">Water</label>
                            <span><i class="fas fa-location-pin"></i></span>
                        </div>
                        <div id="mode-wedm">
                            <label title="Wire EDM Cutting">Wire</label>
                            <span><i class="fas fa-ellipsis-vertical"></i></span>
                        </div>
                        <div id="mode-drag">
                            <label title="Drag Knife Cutting">Drag</label>
                            <span><i class="fas fa-caret-left"></i></span>
                        </div>
                    </div>
                </div>
            </span>
            <!-- setup menu -->
            <span style="pointer-events: none; opacity: 0.3; display:none;">
                <i class="fas fa-cog"></i>
                <label lk="su_menu">setup</label>
                <div class="top-menu-drop top-menu-right">
                    <div class="content">
                        <div id="set-device">
                            <label lk="machines">machines</label>
                            <span><i class="fas fa-cube"></i></span>
                        </div>
                        <div id="set-profs">
                            <label lk="profs">profiles</label>
                            <span><i class="fas fa-sliders-h"></i></span>
                        </div>
                        <div id="set-tools">
                            <label lk="tools">tools</label>
                            <span><i class="fas fa-tools"></i></span>
                        </div>
                        <div id="set-prefs">
                            <label lk="prefs">prefs</label>
                            <span><i class="fa-solid fa-square-check"></i></span>
                        </div>
                    </div>
                </div>
            </span>
            <!-- info menu -->
            <span style="pointer-events: none; opacity: 0.3; display:none;">
                <i class="fas fa-question-circle"></i>
                <label lk="info">info</label>
                <div class="top-menu-drop top-menu-right">
                    <div class="content">
                        <div id="app-help">
                            <label lk="help">help</label>
                        </div>
                        <div id="app-don8">
                            <label lk="donate">donate</label>
                        </div>
                    </div>
                </div>
            </span>
            <span>
                <i class="fas fa-language"></i>
                <div class="top-menu-drop top-menu-right">
                    <div class="content">
                        <div><label id="lset-zh">简体中文</label></div>
                        <div><label id="lset-en">english</label></div>
                        <div><label id="lset-vi">Tiếng Việt</label></div>
                    </div>
                </div>
            </span>
        </div>
    </div>

    <!-- line betwwen menu bar and main application windows -->
    <div id="progress"><div id="progbar"></div><div id="progtxt">loading</div></div>    <!-- progress bar -->
    <div id="progress"><div id="progbar"></div><div id="progtxt">loading</div></div>

    <!-- toolbar with mesh and rendering options (hidden via CSS) -->
    <div>
        <div id="render-tools" style="display:none;">
            <span id="tool-nozzle"><i class="fas fa-location-pin" title="extruder"></i>
                <div id="ft-nozzle" class="f-col pop"></div>
            </span>
            <span id="tool-rotate"><i class="fas fa-rotate-right" title="rotate selection"></i>
                <div id="ft-rotate" class="grid pop">
                    <div id="rot_x_lt"><i class="fas fa-chevron-left"></i></div>
                    <label>X</label>
                    <div id="rot_x_gt"><i class="fas fa-chevron-right"></i></div>
                    <input id="rot_x" class="value center" size="6" value="5">
                    <div id="rot_y_lt"><i class="fas fa-chevron-left"></i></div>
                    <label>Y</label>
                    <div id="rot_y_gt"><i class="fas fa-chevron-right"></i></div>
                    <input id="rot_y" class="value center" size="6" value="5">
                    <div id="rot_z_lt"><i class="fas fa-chevron-left"></i></div>
                    <label>Z</label>
                    <div id="rot_z_gt"><i class="fas fa-chevron-right"></i></div>
                    <input id="rot_z" class="value center" size="6" value="5">
                    <div class="buttons f-row">
                        <button id="unrotate" class="grow" lk="reset">reset</button>
                    </div>
                </div>
            </span>
            <span id="tool-scale"><i class="fas fa-expand" title="scale or resize selection"></i>
                <div id="ft-scale" class="grid pop">
                    <div><label>X</label><input id="lock_x" type="checkbox" checked></div>
                    <div><label>Y</label><input id="lock_y" type="checkbox" checked></div>
                    <div><label>Z</label><input id="lock_z" type="checkbox" checked></div>
                    <label id="lab-axis" lk="axis">axis</label>
                    <input id="size_x" size="8" class="value">
                    <input id="size_y" size="8" class="value">
                    <input id="size_z" size="8" class="value">
                    <label id="lab-size" lk="size">size</label>
                    <input id="scale_x" size="8" class="value" value="1">
                    <input id="scale_y" size="8" class="value" value="1">
                    <input id="scale_z" size="8" class="value" value="1">
                    <label id="lab-scale" lk="scale">scale</label>
                    <div class="buttons f-row">
                        <button id="scale-reset" class="grow j-center">reset</button>
                    </div>
                </div>
            </span>
            <span id="tool-mesh"><i class="fas fa-dice-d20"></i>
                <div id="ft-mesh" class="grow f-col pop">
                    <div id="ft-mesh-btn">
                        <div><button id="mesh-merge" lk="rc_merg">Merge</button></div>
                        <div><button id="mesh-split" lk="rc_splt">Isolate Bodies</button></div>
                        <div><button id="mesh-export-obj" lk="rc_xobj">export OBJ</button></div>
                        <div><button id="mesh-export-stl" lk="rc_xstl">export STL</button></div>
                    </div>
                </div>
            </span>
            <span id="context-mirror" xlk="rc_mirr">
                <i class="fas fa-arrows-left-right-to-line"></i>
                <div class="pop">mirror selection</div>
            </span>
            <span id="context-duplicate" xlk="rc_dupl">
                <i class="fas fa-copy"></i>
                <div class="pop">duplicate selection</div>
            </span>
            <span id="context-layflat" xlk="rc_lafl">
                <i class="fas fa-arrows-down-to-line"></i>
                <div class="pop">choose a face to place<br>on the work surface</div>
            </span>
            <span id="context-lefty" xlk="rc_lafl">
                <i class="fas fa-arrows-down-to-line rot90"></i>
                <div class="pop">choose a face to align<br>to the y axis</div>
            </span>
            <span id="context-setfocus" xlk="rc_focs">
                <i class="fas fa-eye"></i>
                <div class="pop">choose focal point<br>camera orbit center</div>
            </span>
            <span id="render-solid" class="j-center">
                <i class="fas fa-square"></i>
                <div class="pop">render objects solid</div>
            </span>
            <span id="render-wire" class="j-center">
                <i class="fas fa-border-all"></i>
                <div class="pop">render objects wireframe</div>
            </span>
            <span id="render-ghost" class="a-center">
                <i class="fas fa-border-none"></i>
                <div class="pop">render objects transparent</div>
            </span>
            <span id="render-edges" class="a-center">
                <i class="fa-regular fa-square"></i>
                <div class="pop">trace edges</div>
            </span>
        </div>
    </div>

    <!-- main workspace (hidden via CSS) -->
    <div id="mid" class="grow f-row">
        <div id="panel-left" class="f-col j-left">
            <div id="slide-show"><span><i class="fa-solid fa-arrow-right"></i></span></div>
            <div class="f-col grow settings">
                <div id="fdm-key-settings" class="set2-group mode-fdm"></div>
                <div id="cam-tabs" class="set2-group mode-cam"></div>
                <div id="cam-stock" class="set2-group mode-cam"></div>
                <div id="cam-limits" class="set2-group mode-cam"></div>
                <div id="cam-output" class="set2-group mode-cam"></div>
                <div id="cam-origin" class="set2-group mode-cam"></div>
                <div id="cam-expert" class="set2-group mode-cam"></div>
                <div id="lzr-slice" class="set2-group mode-laser"></div>
                <div id="lzr-surface" class="set2-group mode-laser"></div>
                <div id="lzr-knife" class="set2-group mode-laser"></div>
                <div id="lzr-layout" class="set2-group mode-laser"></div>
                <div id="lzr-output" class="set2-group mode-laser"></div>
                <div id="sla-slice" class="set2-group mode-sla"></div>
                <div id="sla-layers" class="set2-group mode-sla"></div>
                <div id="sla-base" class="set2-group mode-sla"></div>
                <div id="sla-fill" class="set2-group mode-sla"></div>
                <div id="sla-support" class="set2-group mode-sla"></div>
                <div id="sla-output" class="set2-group mode-sla"></div>
            </div>
            <div class="line-sep2"></div>
            <div class="chonk"></div>
        </div>

        <div id="mid-mid" class="grow">
            <div id="layer-slider" class="f-col a-stretch">
                <div id="layers" class="f-row j-center gap2"></div>
                <div id="slider" class="f-row russo">
                    <div id="slider-zero">0</div>
                    <div id="slider-center" class="grow">
                        <div id="slider-line"></div>
                        <div id="slider-hold" class="f-row">
                            <div id="slider-lo" class="handle"><div id="slider-lo-val"></div></div>
                            <div id="slider-mid">&nbsp;</div>
                            <div id="slider-hi" class="handle"><div id="slider-hi-val"></div></div>
                        </div>
                    </div>
                    <div id="slider-max">&infin;</div>
                </div>
            </div>
            <div id="top-slider" class="f-col grow">
                <input id="anim-slider" type="range" min="0" max="1000" value="0">
            </div>
            <div id="layer-animate" class="f-col a-center set2-group hide"></div>
        </div>

        <div class="f-row j-center">
            <div id="set-menu" class="f-col">
                <div id="speeds"><div id="speedbar" class="f-col a-stretch j-center" lkt="sb_info"></div></div>
            </div>
            <div id="panel-right" class="f-col j-start settings">
                <div id="mode-info" style="pointer-events: none; opacity: 0.6;">
                    <div><label lk="mi_devi">Device</label><span id="mode-device"></span></div>
                    <div><label lk="mi_prof">Profile</label><span id="mode-profile"></span></div>
                </div>
                <div class="set2-group f-col">
                    <details open>
                        <summary class="set-header"><a>objects</a></summary>
                        <div id="ws-widgets" class="f-col"></div>
                    </details>
                </div>
                <div class="set2-group f-col mode-fdm">
                    <div class="set-header"><a>ranges</a></div>
                    <div id="fdm-ranges" class="f-col"></div>
                </div>
                <div class="set2-group f-col mode-cam">
                    <div class="set-header mode-cam"><a>operation list</a></div>
                    <div id="camops" class="f-col a-stretch grow">
                        <div id="oplist" class="f-col"></div>
                        <div id="op-add" class="opdiv">
                            <i class="fas fa-plus"></i>
                            <div id="op-add-pop" class="f-col">
                                <div id="op-add-list" class="opdiv op-grid">
                                    <div id="cam-index" title="rotate index axis">index</div>
                                    <div id="cam-lathe" title="lathe operation">lathe</div>
                                    <div id="laser-on" title="turn on laser mode">laser on</div>
                                    <div id="laser-off" title="turn off laser mode">laser off</div>
                                    <div id="cam-flip" title="flip part and load&#13;profile for other side&#13;for double-sided work">flip</div>
                                    <div id="cam-reg" title="drill registration holes&#13;along the X or Y axis&#13;for double-sided work">register</div>
                                    <div title="drill any holes matching&#13;selected tool diameter">drill</div>
                                    <div title="clear stock face&#13;or top of part&#13;when no stock">level</div>
                                    <div title="follow selected features with&#13;a specified tool. often used&#13;for lettering and engraving">trace</div>
                                    <div title="insert custom gcode">gcode</div>
                                    <div title="remove an area of material&#13;inside a defined boundary&#13;sometimes called pocketing">rough</div>
                                    <div title="clean up after roughing&#13;or perform a part cutout">outline</div>
                                    <div title="2.5D tracing along X or Y axis&#13;used for complex part features">contour</div>
                                    <div title="clear areas above&#13;selected surfaces">pocket</div>
                                    <div title="follow a helix&#13;around circular paths">helical</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grow"></div>
                <div class="line-sep2"></div>
                <div class="chonk"></div>
            </div>
        </div>
    </div>

    <!-- ThreeJS container (used by kiri) -->
    <div id="container"></div>

    <!-- modal dialogs-->
    <div id="modal">
        <div id="modal-box" class="f-col">

        <!-- title bar and closer -->
        <div class="mod-top f-row"><div id="mod-x" class="mod-x"><i class="fas fa-times"></i></div></div>

        <!-- donate menu -->
        <div id="mod-don8" class="mdialog f-col">
            <div class="f-col gap4" style="gap:5px">
                <div class="t-pad2"></div>
                <div style="padding:20px;font-size:larger;font-weight:bold">Your contribution is appreciated!</div>
                <div style="padding:5px 0 5px 0;justify-content:center">And supports ongoing development,</div>
                <div style="padding:5px 0 20px 0;justify-content:center">servers, forums, and related costs</div>
                <button id="don8pt" class="yellow" style="justify-content:center;padding:25px;font-size:larger"><a target="_paypal" href="https://www.patreon.com/c/gridspace3d">Become a Patreon Patron</a></button>
                <button id="don8gh" class="yellow" style="justify-content:center;padding:25px;font-size:larger"><a target="_github" href="https://github.com/sponsors/GridSpace">Sponsor on GitHub</a></button>
                <button id="don8pp" class="yellow" style="justify-content:center;padding:25px;font-size:larger"><a target="_paypal" href="https://paypal.me/gridspace3d">Donate with PayPal</a></button>
                <div class="t-pad2"></div>
            </div>
        </div>

        <!-- help menu -->
        <div id="mod-help" class="mdialog f-col">
            <div class="f-row j-center title">
                <label>The Uy 3D Printing Service Help</label>
            </div>
            <hr width="100%">
            <div class="f-col">
                <a target="_rsc" href="https://docs.grid.space/projects/kiri-moto"><i class="fas fa-question-circle"></i>Documentation & APIs</a>
                <a target="_rsc" href="https://forum.grid.space"><i class="fab fa-discourse"></i> Discourse Forums</a>
                <a target="_rsc" href="https://discord.gg/suyCCgr"><i class="fab fa-discord"></i> Discord Server</a>
                <a target="_rsc" href="https://github.com/gridspace/grid-apps/issues"><i class="fas fa-bug"></i> Bug Reports</a>
                <a target="_rsc" href="https://github.com/gridspace/grid-apps/releases"><i class="fab fa-github"></i> Releases & Binaries</a>
                <a target="_rsc" onclick="kiri.api.modal.show('don8')"><i class="fa-solid fa-sack-dollar"></i> Support Development</a>
                <a href="https://youtu.be/08795Sj22QE" target="youtube"><i class="fab fa-youtube"></i>Video Guide (from v2.5)</a>
            </div>
            <hr width="100%">
            <div class="f-row j-center">
                <label id="kiri-version"></label>
            </div>
        </div>

        <!-- device selector / editor -->
        <div id="mod-setup" class="mdialog f-col gap3">
            <div class="f-row gap4 a-center">
                <label id="dev-sel" class="set-header">select device</label>
                <select id="dev-list"></select>
                <div class="f-row grow j-end">
                    <button id="device-add" lk="copy">copy</button>
                    <button id="device-ren" lk="rename">rename</button>
                    <button id="device-del" lk="delete">delete</button>
                    <button id="device-exp" lk="export">export</button>
                </div>
            </div>
            <div class="set-sep"></div>
            <div class="f-row grow gap4">
                <div id="dev-config" class="f-col gap4 overy shrink0"></div>
                <div class="f-col grow">
                    <div id="gcode-edit" class="f-col grow gap4">
                        <div id="dg" class="f-col t-body t-inset"></div>
                        <div id="dev-gcode" class="grow"></div>
                    </div>
                </div>
            </div>
            <div class="set-sep"></div>
            <div id="device-action" class="f-row">
                <div class="grow"></div>
                <button id="device-save" lk="save">save</button>
                <div class="grow"></div>
            </div>
        </div>

        <!-- recent file menu -->
        <div id="mod-files" class="mdialog f-col">
            <label class="set-header menu-title" lk="dm_rcnt">recent files</label>
            <div id="catalogList" class="f-col"></div>
        </div>

        <!-- settings list and editor -->
        <div id="mod-saves" class="mdialog f-col">
            <label class="set-header menu-title" lk="dm_savs">settings</label>
            <div id="settingsList" class="f-col"></div>
            <div id="settingsNew">
                <input id="settingsName" class="grow"></input>
                <button id="settingsSave" lk="save">Save</button>
            </div>
        </div>

        <!-- cnc tool menu -->
        <div id="mod-tools" class="mdialog">
            <div class="f-col gap3">
                <div class="f-row t-head gap3">
                    <label class="t-33 set-header" lk="tool">tool</label>
                    <label class="t-33 set-header" lk="detail">detail</label>
                    <label class="t-33 set-header" lk="view">view</label>
                </div>
                <div id="tool-cols" class="f-row gap3">
                    <div class="f-col t-33">
                        <select id="tool-select" size="10" class="grow"></select>
                    </div>
                    <div class="f-col t-33 t-body t-inset">
                        <div class="f-row var-row"><label lk="name">name</label><input id="tool-name" ></input></div>
                        <div class="f-row var-row"><label lk="type">type</label>
                            <select id="tool-type">
                                <option value="endmill" lk="td_tyem" selected>end</option>
                                <option value="ballmill" lk="td_tybm">ball</option>
                                <option value="tapermill" lk="td_tytm">taper</option>
                                <option value="drill" lk="td_tydr">drill</option>
                            </select>
                        </div>
                        <div class="f-row var-row" title="tool number to use&#010;in gcode commands"><label lk="td_tonm">tool #</label><input id="tool-num" ></input></div>
                        <div class="f-row var-row"><label lk="metric">metric</label><input id="tool-metric" type="checkbox"></input></div>
                        <div class="set-header f-col" lk="td_shft">shaft</div>
                        <div class="f-row var-row" title="shaft diameter in inches&#010;unless metric is checked&#010;then in millimeters"><label>diameter</label><input id="tool-sdiam" ></input></div>
                        <div class="f-row var-row" title="shaft length in inches&#010;unless metric is checked&#010;then in millimeters"><label>length</label><input id="tool-slen" ></input></div>
                        <div class="set-header f-col" lk="td_flut">flute</div>
                        <div class="f-row var-row" title="flute diameter in inches&#010;unless metric is checked&#010;then in millimeters"><label>diameter</label><input id="tool-fdiam" ></input></div>
                        <div class="f-row var-row" title="flute length in inches&#010;unless metric is checked&#010;then in millimeters"><label>length</label><input id="tool-flen" ></input></div>
                        <div class="set-header f-col" ln="td_tapr">taper</div>
                        <div class="f-row var-row" title="taper angle is measured from the center of the tool"><label>angle</label><input id="tool-tangle" size=7></input></div>
                        <div class="f-row var-row" title="tip width in inches&#010;unless metric is checked&#010;then in millimeters"><label>tip</label><input id="tool-ttip" ></input></div>
                    </div>
                    <div id="tool-view" class="f-col t-33 t-body"></div>
                </div>
                <div class="set-sep"></div>
                <div id="tool-action" class="f-row j-center gap10">
                    <div class="f-row">
                        <button id="tool-add"><i class="fas fa-plus"></i></button>
                        <button id="tool-dup" lk="clone">copy</button>
                        <button id="tool-del"><i class="fas fa-minus"></i></button>
                    </div>
                    <div class="f-row">
                        <button id="tools-save" lk="save">save</button>
                        <button id="tools-close" lk="done">done</button>
                    </div>
                    <div class="f-row">
                        <button id="tools-import" lk="import">import</button>
                        <button id="tools-export" lk="export">export</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- system preferences -->
        <div id="mod-prefs" class="mdialog f-col a-center">
            <label lk="dm_appp" class="menu-title">Application Preferences</label>
            <hr width="80%">
            <div class="f-row gap10">
                <div id="prefs-gen1" class="f-col"></div>
                <div id="prefs-gen2" class="f-col"></div>
                <div id="prefs-lay" class="f-col"></div>
                <div id="prefs-xpo" class="f-col"></div>
                <div id="prefs-prt" class="f-col"></div>
                <div id="prefs-add" class="f-col"></div>
            </div>
        </div>

        <!-- export dialogs -->
        <div id="mod-x-any" class="mod-print mdialog f-col">
            <div class="f-row gap4">
                <div class="f-col grow">
                    <div class="header"><label lk="ex_job">job</label></div>
                    <div id="print-info" class="f-col box">
                        <div style="display:none;"><label lk="ex_fnam">file name</label><input id="print-filename" size="20" spellcheck="false" /></div>
                        <div><label lk="ex_fsiz">file size (bytes)</label><input id="print-filesize" size="12" disabled="true" /></div>
                        <div><label lk="ex_time">time estimate (h:m:s)</label><input id="output-time" size="12" disabled="true" /></div>
                    </div>
                </div>
                <div id="print-filament" class="f-col">
                    <div class="header"><label lk="ex_matl">material</label></div>
                    <div class="f-col box">
                        <div style="display:none;"><label lk="ex_dens">filament density (g/cm^3)</label><input id="print-density" size="12" value="1.25" /></div>
                        <div><label lk="ex_fuse">filament used (mm)</label><input id="print-length" size="12" disabled="true" /></div>
                        <div><label lk="ex_wght">printed weight (g)</label><input id="print-weight" size="12" disabled="true" /></div>
                    </div>
                </div>
            </div>
            <div id="code-preview-head" class="header"><label lk="ex_gcpv">gcode preview</label></div>
            <div id="code-preview" class="f-col box">
                <div><textarea id="code-preview-textarea"></textarea></div>
            </div>
            <div class="header" style="display:none;"><label lk="ex_dwnl">download</label></div>
            <div class="f-row box" style="display:none;">
                <button id="print-download" class="grow">gcode</button>
                <button id="print-palette" class="grow">palette</button>
                <button id="print-zip" class="grow">zip</button>
                <button id="print-3mf" class="grow">3mf</button>
            </div>
            <div class="header"><label>price calculation</label></div>
            <div class="f-row box">
                <div class="f-col grow">
                    <label>weight (g)</label>
                    <input id="print-weight-display" size="12" disabled="true" />
                </div>
                <div class="f-col grow">
                    <label>time estimate</label>
                    <input id="output-time-display" size="12" disabled="true" />
                </div>
                <div class="f-col grow">
                    <label>calculated price</label>
                    <input id="calculated-price" size="12" value="0" disabled="true" />
                </div>
            </div>
            <div id="bambu-output" class="f-col">
                <div class="header"><label lk="ex_bamb">send to bambu</label></div>
                <div class="f-row box gap4 a-center">
                    <label class="grow0 pad3">printer</label>
                    <select id="print-bambu-device"></select>
                    <label class="grow0 pad3">spool</label>
                    <select id="print-bambu-spool"></select>
                    <button id="print-bambu-1" class="grow" disabled>send</button>
                    <button id="print-bambu-2" class="grow" disabled>send + print</button>
                </div>
            </div>
            <div id="send-to-octohead" class="header"><label>octoprint</label></div>
            <div id="send-to-octoprint" class="f-col box">
                <div class="grow f-row">
                    <div class="f-col grow">
                        <div id="ophost"><label lk="ex_host">host</label><input id="octo-host" size="20" placeholder="http(s)://host:port" /></div>
                        <div id="opapik"><label lk="ex_akey">key</label><input id="octo-apik" size="20" /></div>
                    </div>
                    <button id="print-octoprint">send</button>
                </div>
                <div id="oph1nt"><label class="hint"><a href="http://docs.octoprint.org/en/master/api/general.html?highlight=cors#cross-origin-requests" target="_help">CORS support</a> must be enabled in API settings</label></div>
            </div>
            <div id="minio-head" class="header"><label>minio storage</label></div>
            <div id="minio-panel" class="f-col box">
                <div class="f-row gap4 a-center">
                    <label class="grow0 pad3">path</label>
                    <input id="minio-path" class="grow" placeholder="prints/job.gcode" />
                    <button id="print-minio-upload" class="grow0">upload</button>
                </div>
                <div class="f-row gap4 a-center">
                    <button id="print-minio-refresh" class="grow">refresh list</button>
                    <span id="minio-status" class="hint grow"></span>
                </div>
                <div id="minio-list" class="f-col gap3"></div>
            </div>
        </div>
        <div id="mod-x-sla" class="mod-print mdialog f-col">
            <div class="header"><label lk="export">export</label></div>
            <div id="print-info" class="f-col box">
                <div><label lk="ex_fnam">file name</label><input id="print-filename-sla" size="20" spellcheck="false" /></div>
                <div><label>resin used ML</label><input id="print-volume" size="10" spellcheck="false" /></div>
                <div><label>layers</label><input id="print-layers" size="10" spellcheck="false" /></div>
                <div><label>print time</label><input id="print-time" size="10" spellcheck="false" /></div>
            </div>
            <div class="header"><label lk="ex_dwnl">download</label></div>
            <div class="f-row box">
                <button id="print-sla" class="grow" lk="ex_dwnl">download</button>
            </div>
        </div>
        <div id="mod-x-laser" class="mod-print mdialog f-col">
            <div class="header"><label lk="export">export</label></div>
            <div id="print-info" class="f-col box">
                <div><label lk="ex_fnam">file name</label><input id="print-filename-laser" size="20" spellcheck="false" /></div>
                <div><label>segments</label><input id="print-lines" size="12" disabled="true" /></div>
            </div>
            <div class="header"><label lk="ex_dwnl">download</label></div>
            <div class="f-row box">
                <button id="print-svg" class="grow">svg</button>
                <button id="print-dxf" class="grow">dxf</button>
                <button id="print-lg" class="grow">gcode</button>
            </div>
        </div>
        <!-- dynamic dialogs -->
        <div id="mod-any" class="mdialog f-col"></div>
        <div class="mod-end"></div></div>
    </div>

    <!-- generic dialog -->
    <dialog id="dialog"></dialog>

    <!-- mouse tracking -->
    <div id="tracker"></div>

    <!-- EU compliance (kept hidden) -->
    <div id="gdpr" class="noshow" hidden style="display:none;position:fixed;width:0;height:0;overflow:hidden;opacity:0;padding:0;border:none;background:transparent;box-shadow:none;">
        <p style="display:none;">this site uses <a href="/privacy.html" target="privacy">cookies</a> to preserve application preferences</p>
        <button id="gotit" class="f-col j-center" style="display:none;">got it</button>
    </div>

    <!-- developer debugging -->
    <div id="stats">
        <div id="rms"></div>
        <div id="fps"></div>
        <div id="rnfo"></div>
    </div>

    <!-- ephemeral alerts -->
    <div id="alert-area" style="display:none;">
        <div id="alert-border">
            <div id="alert-text">alerts<br>alerts<br>alerts</div>
        </div>
    </div>

</div>

<!-- Simple UI controller (real logic from v1) -->
<script type="module" src="simple-ui.js"></script>

<!-- Slice preview slider controls inlined for easier Tailwind tweaking -->
<script>
(() => {
    let previewReady = false;
    let domCache;
    const getDom = () => {
        if (domCache) return domCache;
        domCache = {
            panel: document.getElementById('slice-preview-panel'),
            slider: document.getElementById('slice-layer-slider'),
            label: document.getElementById('slice-layer-label'),
            hint: document.getElementById('slice-preview-hint')
        };
        return domCache;
    };

    const showPanel = dom => {
        if (!dom.panel) return;
        dom.panel.classList.remove('hidden');
        dom.panel.classList.add('flex');
        if (dom.slider) {
            dom.panel.classList.toggle('opacity-60', dom.slider.disabled);
        }
    };

    const updateLabel = (dom, layer, max) => {
        if (!dom.label) return;
        if (layer < 0 || max <= 0) {
            dom.label.textContent = '-- / --';
            return;
        }
        const safeLayer = Math.max(0, Math.min(layer, max));
        dom.label.textContent = `${safeLayer} / ${max}`;
    };

    const setHint = (dom, message) => {
        if (dom.hint && typeof message === 'string') {
            dom.hint.textContent = message;
        }
    };

    const disableSlider = (dom, hint) => {
        previewReady = false;
        if (dom.slider) {
            dom.slider.disabled = true;
            dom.slider.value = 0;
            dom.slider.max = 0;
        }
        showPanel(dom);
        updateLabel(dom, -1, -1);
        setHint(dom, hint || 'Slice to view.');
    };

    const resetPreview = () => {
        const dom = getDom();
        disableSlider(dom, 'Slice to view.');
    };

    const syncFromApi = (api, dom, hint) => {
        if (!previewReady) {
            disableSlider(dom, 'Slice to view.');
            return;
        }
        if (!dom.slider) return;
        const max = Math.max(0, api?.var?.layer_max || 0);
        const activeLayer = Math.min(max, Math.max(0, api?.var?.layer_hi || 0));
        dom.slider.max = max;
        dom.slider.value = activeLayer;
        dom.slider.disabled = false;
        showPanel(dom);
        updateLabel(dom, activeLayer, max);
        dom.panel?.classList.remove('opacity-60');
        setHint(dom, hint || 'Drag to scrub.');
    };

    const attachSlider = api => {
        const dom = getDom();
        if (!dom.slider) {
            return;
        }

        dom.slider.addEventListener('input', () => {
            if (dom.slider.disabled) {
                return;
            }
            const target = parseInt(dom.slider.value, 10);
            if (!Number.isNaN(target)) {
                api.show.layer(target, 0);
            }
        });

        disableSlider(dom, 'Upload & slice to scrub.');
        api.event.on('slice.begin', () => disableSlider(dom, 'Slicing...'));
        api.event.on('slice.error', () => disableSlider(dom, 'Slice failed. Check settings.'));
        api.event.on('slice.end', () => {
            previewReady = true;
            syncFromApi(api, dom, 'Preview ready. Scrub.');
        });
        api.event.on('preview.end', () => {
            previewReady = true;
            syncFromApi(api, dom, 'Preview ready. Scrub.');
        });
        api.event.on('slider.label', () => {
            if (previewReady) {
                syncFromApi(api, dom);
            } else {
                disableSlider(dom, 'Slice to view.');
            }
        });
    };

    const waitForKiri = (retry = 0) => {
        if (self.kiri_api) {
            attachSlider(self.kiri_api);
            return;
        }
        if (retry > 200) {
            console.warn('kiri_api not available yet for slice slider');
            return;
        }
        setTimeout(() => waitForKiri(retry + 1), 50);
    };

    document.addEventListener('DOMContentLoaded', () => {
        const dom = getDom();
        disableSlider(dom, 'Slice to view.');
        waitForKiri();
    });

    window.addEventListener('slice-preview-reset', resetPreview);
    window.addEventListener('kiri-platform-resize', () => {
        const dom = getDom();
        disableSlider(dom, 'Slice to view.');
    });
})();
</script>

<!-- Tiny helper: keep infill label in sync (doesn't touch slicing logic) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const infill = document.getElementById('customer-infill-amount');
    const infillLabel = document.getElementById('customer-infill-value');
    if (infill && infillLabel) {
        const update = () => infillLabel.textContent = infill.value + '%';
        infill.addEventListener('input', update);
        update();
    }
});
</script>

</body>
</html>
